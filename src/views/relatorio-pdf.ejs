<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Relatório — Operação <%= (opHeader && opHeader.nome) || '' %></title>
  <style>
    :root{--text:#0b1220;--muted:#555;--border:#d9d9d9;--panel:#fff;--chip:#eef2ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;color:var(--text)}
    .wrap{max-width:800px;margin:28px auto;padding:0 16px}
    .center{text-align:center}
    .logo{width:90px;height:auto;margin:8px auto 4px;display:block}
    .org1{font-size:22px;font-weight:800;letter-spacing:2px}
    .org2{font-size:14px;margin-top:2px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:14px}
    h2{font-size:16px;margin:0 0 8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 8px;border-bottom:1px solid var(--border);vertical-align:top}
    th{width:190px;text-align:left;color:var(--muted);font-weight:600}
    .kv{margin-top:6px}
    .kpi-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .kpi{border:1px solid var(--border);border-radius:10px;padding:10px}
    .kpi .lbl{font-size:12px;color:var(--muted)}
    .kpi .val{font-size:20px;font-weight:800;margin-top:2px}
    .row-title{display:flex;justify-content:space-between;gap:12px;align-items:center}
    .ts{color:var(--muted);font-size:12px;white-space:nowrap}
    .chips{margin:6px 0 0}
    .chip{display:inline-block;background:var(--chip);border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px}
    .items th, .items td{text-align:left}
    .items thead th{background:#f6f6f9}
    .muted{color:var(--muted)}
    @page { size: A4; margin: 20mm 15mm; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Cabeçalho -->
    <div class="center">
      <img class="logo" src="<%= logoUrl %>" alt="Logo CIM"/>
      <div class="org1">C.I.M</div>
      <div class="org2">Centro de Inteligência Metropolitana</div>
    </div>

    <!-- Card: informações da operação -->
    <div class="card">
      <h2>Informações da operação</h2>
      <table class="kv">
        <tr><th>Nome</th><td><%= (opHeader && opHeader.nome) || '-' %></td></tr>
        <tr><th>Descrição</th><td><%= (opHeader && opHeader.descricao) || '-' %></td></tr>
        <tr><th>Início agendado</th><td><%= (opHeader && opHeader.inicio_agendado_fmt) || '-' %></td></tr>
        <tr><th>Cidades participantes</th><td><%= (opHeader && opHeader.cidades_participantes) || '-' %></td></tr>
      </table>
    </div>

    <!-- KPIs principais -->
    <div class="card">
      <h2>Resumo</h2>
      <div class="kpi-grid">
        <div class="kpi"><div class="lbl">Fiscalizações</div><div class="val"><%= (cards && cards.fiscalizacoes) || 0 %></div></div>
        <div class="kpi"><div class="lbl">Pessoas</div><div class="val"><%= (cards && cards.pessoas) || 0 %></div></div>
        <div class="kpi"><div class="lbl">Veículos</div><div class="val"><%= (cards && cards.veiculos) || 0 %></div></div>
        <div class="kpi"><div class="lbl">Detidos</div><div class="val"><%= (cards && cards.detidos) || 0 %></div></div>
        <div class="kpi"><div class="lbl">Multados</div><div class="val"><%= (cards && cards.multados) || 0 %></div></div>
        <div class="kpi"><div class="lbl">Fechados</div><div class="val"><%= (cards && cards.fechados) || 0 %></div></div>
        <div class="kpi"><div class="lbl">Lacrados</div><div class="val"><%= (cards && cards.lacrados) || 0 %></div></div>
        <div class="kpi"><div class="lbl">Itens apreendidos</div><div class="val"><%= (cards && cards.itensApreendidos) || 0 %></div></div>
        <div class="kpi"><div class="lbl">Apreensões</div><div class="val"><%= (cards && cards.apreensoes) || 0 %></div></div>
      </div>
    </div>

    <!-- Cards de cada fiscalização -->
    <% (fiscList || []).forEach(function(r){ %>
      <div class="card">
        <div class="row-title">
          <h2>#<%= r.evento_id %> — <%= r.cidade || '-' %></h2>
          <div class="ts"><%= new Date(r.ts).toLocaleString('pt-BR') %></div>
        </div>

        <div class="chips">
          <% if (r.multado) { %><span class="chip">Multado</span><% } %>
          <% if (r.fechado) { %><span class="chip">Fechado</span><% } %>
          <% if (r.lacrado) { %><span class="chip">Lacrado</span><% } %>
        </div>

        <table class="kv" style="margin-top:6px">
          <tr><th>Tipo de local</th><td><%= r.tipo_local || '-' %></td></tr>
          <tr><th>Nome do local</th><td><%= r.local_nome || '-' %></td></tr>
          <tr><th>Endereço</th><td><%= r.local_endereco || '-' %></td></tr>
          <tr><th>Pessoas</th><td><%= Number(r.pessoas_abordadas||0) %></td></tr>
          <tr><th>Veículos</th><td><%= Number(r.veiculos_abordados||0) %></td></tr>
          <tr><th>Pessoas detidas</th><td><%= Number(r.pessoas_detidas_qtd||0) %></td></tr>
          <tr><th>Itens apreendidos (qtd.)</th><td><%= Number(r.itens_apreendidos||0) %></td></tr>
          <tr><th>Usuário</th><td><%= r.usuario || '-' %></td></tr>
        </table>

        <% if (Array.isArray(r.itens) && r.itens.length) { %>
          <h3 style="font-size:14px;margin:12px 0 6px">Itens apreendidos</h3>
          <table class="items">
            <thead>
              <tr><th style="width:40px">#</th><th>Tipo</th><th style="width:120px">Quantidade</th><th style="width:120px">Unidade</th></tr>
            </thead>
            <tbody>
              <% r.itens.forEach(function(i, idx){ %>
                <tr>
                  <td><%= idx+1 %></td>
                  <td><%= i.tipo || '-' %></td>
                  <td><%= (i.quantidade!=null ? i.quantidade : '-') %></td>
                  <td><%= i.unidade || '-' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </div>
    <% }) %>

    <% if (!(fiscList && fiscList.length)) { %>
      <div class="card"><span class="muted">Nenhuma fiscalização para os filtros selecionados.</span></div>
    <% } %>
  </div>
</body>
</html>
