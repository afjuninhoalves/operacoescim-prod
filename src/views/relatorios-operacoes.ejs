<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Relatórios — Operações</title>
    <style>
        :root {
            --bg: #0b1220;
            --panel: #0f172a;
            --panel2: #111827;
            --border: #1f2937;
            --text: #e5e7eb;
            --muted: #9ca3af
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial
        }

        .container {
            max-width: 1160px;
            margin: 0 auto;
            padding: 20px
        }

        .card {
            background: linear-gradient(180deg, var(--panel), var(--panel2));
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px
        }

        .grid {
            display: grid;
            gap: 12px
        }

        .grid-2 {
            grid-template-columns: 1.2fr .8fr
        }

        .kpi {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px
        }

        .box {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px
        }

        .box .label {
            font-size: 12px;
            color: var(--muted)
        }

        .box .value {
            font-size: 24px;
            font-weight: 700;
            margin-top: 2px
        }

        .muted {
            color: var(--muted)
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid var(--border);
            text-align: center
        }

        th:first-child,
        td:first-child {
            text-align: left
        }

        tfoot th,
        tfoot td {
            font-weight: 700
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end
        }

        input,
        select {
            background: #0f172a;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px
        }

        .btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #111826;
            color: #fff;
            cursor: pointer
        }

        .btn[aria-disabled="true"] {
            opacity: .5;
            cursor: not-allowed
        }

        .hidden {
            display: none
        }

        /* Cards de fiscalizações */
        .cards-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px
        }

        .pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #1f2937;
            font-size: 12px;
            margin-right: 6px
        }

        .kv {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 4px 8px;
            font-size: 13px
        }

        .kv .k {
            color: var(--muted)
        }

        /* Lista de itens apreendidos nos cards */
        .itens {
            margin: 6px 0 0 0;
            padding-left: 18px
        }

        .itens li {
            font-size: 13px;
            line-height: 1.3
        }
    </style>

    <!-- html2pdf (gera PDF no cliente) -->
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>

<body>
    <div class="container">
        <h2 style="margin:0 0 12px">Relatórios — Operações</h2>

        <!-- Filtros -->
        <form id="filtros" class="card toolbar">
            <div>
                <label>De<br /><input type="date" name="from" value="<%= filtrosInit.from %>"></label>
            </div>
            <div>
                <label>Até<br /><input type="date" name="to" value="<%= filtrosInit.to %>"></label>
            </div>
            <div>
                <label>Operação<br />
                    <select name="opId" id="opId">
                        <option value="">Selecione…</option>
                        <% (ops||[]).forEach(o=>{ %>
                            <option value="<%= o.id %>">
                                <%= o.id %> — <%= o.nome %>
                            </option>
                            <% }) %>
                    </select>
                </label>
            </div>
            <div>
                <label>Cidade<br />
                    <select name="cidadeId" id="cidadeId">
                        <option value="">Todas</option>
                        <% (cidades||[]).forEach(c=>{ %>
                            <option value="<%= c.id %>">
                                <%= c.nome %>
                            </option>
                            <% }) %>
                    </select>
                </label>
            </div>

            <button class="btn" type="submit">Aplicar</button>

            <!-- Exportações -->
            <a id="btnCsv" class="btn" href="#" aria-disabled="true">CSV (por cidade)</a>
            <a id="btnXlsx" class="btn" href="#" aria-disabled="true">Excel (.xlsx)</a>
            <button id="btnPdf" type="button" class="btn" aria-disabled="true">PDF</button>
        </form>

        <!-- Conteúdo: oculto até escolher operação -->
        <div id="content" class="hidden">
            <!-- Resumo (KPIs) -->
            <div class="kpi" style="margin:12px 0">
                <div class="box">
                    <div class="label">Fiscalizações</div>
                    <div id="k-fisc" class="value">—</div>
                </div>
                <div class="box">
                    <div class="label">Pessoas</div>
                    <div id="k-pes" class="value">—</div>
                </div>
                <div class="box">
                    <div class="label">Veículos</div>
                    <div id="k-vei" class="value">—</div>
                </div>
                <div class="box">
                    <div class="label">Detidos</div>
                    <div id="k-det" class="value">—</div>
                </div>
                <div class="box">
                    <div class="label">Itens apreendidos</div>
                    <div id="k-itens" class="value">—</div>
                </div>
                <div class="box">
                    <div class="label">Apreensões</div>
                    <div id="k-apr" class="value">—</div>
                </div>
                <div class="box">
                    <div class="label">Multados</div>
                    <div id="k-mul" class="value">—</div>
                </div>
                <div class="box">
                    <div class="label">Fechados</div>
                    <div id="k-fec" class="value">—</div>
                </div>
                <div class="box">
                    <div class="label">Lacrados</div>
                    <div id="k-lac" class="value">—</div>
                </div>
            </div>

            <div class="grid grid-2">
                <!-- Distribuição por cidade -->
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div style="font-weight:700">Distribuição por cidade</div>
                        <div class="muted" style="font-size:12px">inclui % de participação</div>
                    </div>

                    <table id="tblCidade">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Fiscalizações</th>
                                <th>% part.</th>
                                <th>Pessoas</th>
                                <th>Veículos</th>
                                <th>Detidos</th>
                                <th>Itens</th>
                                <th>Apreensões</th>
                                <th>Multados</th>
                                <th>Fechados</th>
                                <th>Lacrados</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr>
                                <th>Total</th>
                                <th id="t-fisc" class="num"></th>
                                <th id="t-part" class="num">100%</th>
                                <th id="t-pes" class="num"></th>
                                <th id="t-vei" class="num"></th>
                                <th id="t-det" class="num"></th>
                                <th id="t-itm" class="num"></th>
                                <th id="t-apr" class="num"></th>
                                <th id="t-mul" class="num"></th>
                                <th id="t-fec" class="num"></th>
                                <th id="t-lac" class="num"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Top locais -->
                <div class="card">
                    <div style="font-weight:700;margin-bottom:6px">Top locais fiscalizados</div>
                    <table id="tblTop">
                        <thead>
                            <tr>
                                <th>Local</th>
                                <th>Qtd.</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Lista de fiscalizações (cards) -->
            <div class="card" style="margin-top:12px">
                <div style="font-weight:700;margin-bottom:6px">Fiscalizações</div>
                <div id="fiscCards" class="cards-list"></div>
                <div id="noFisc" class="muted" style="display:none">Nenhuma fiscalização para os filtros escolhidos.
                </div>
            </div>
        </div>
    </div>

  <script>
  // ======= helpers =======
  const qs  = (s) => document.querySelector(s);
  const fmt = (n) => (n ?? 0).toLocaleString('pt-BR');
  const esc = (s) => String(s ?? '').replace(/[&<>"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
  ));
  // ajuste o caminho do seu logo se for diferente
  const LOGO_URL = '/public/images/operaco.jpg';

  // vamos guardar o último payload para o PDF
  let __relatorioData = null;

  function setDisabled(el, disabled){
    if (!el) return;
    if (disabled){ el.setAttribute('aria-disabled','true'); el.classList.add('muted'); }
    else          { el.removeAttribute('aria-disabled');   el.classList.remove('muted'); }
  }
  function enableExports(enabled){
    setDisabled(qs('#btnCsv'),  !enabled);
    setDisabled(qs('#btnXlsx'), !enabled);
    setDisabled(qs('#btnPdf'),  !enabled);
  }
  function linkCsv(){
    const fd = new FormData(qs('#filtros'));
    qs('#btnCsv').href = '/relatorios/export.csv?' + new URLSearchParams(fd).toString();
  }
  function linkXlsx(){
    const fd = new FormData(qs('#filtros'));
    qs('#btnXlsx').href = '/relatorios/export.xlsx?' + new URLSearchParams(fd).toString();
  }

  // ======= renderizações (tela) =======
  function renderKPIs(c){
    qs('#k-fisc').textContent = fmt(c.fiscalizacoes);
    qs('#k-pes').textContent  = fmt(c.pessoas);
    qs('#k-vei').textContent  = fmt(c.veiculos);
    qs('#k-det').textContent  = fmt(c.detidos);
    qs('#k-itens').textContent= fmt(c.itensApreendidos);
    qs('#k-apr').textContent  = fmt(c.apreensoes);
    qs('#k-mul').textContent  = fmt(c.multados);
    qs('#k-fec').textContent  = fmt(c.fechados);
    qs('#k-lac').textContent  = fmt(c.lacrados);
  }

  function renderTopLocais(rows){
    const tb = qs('#tblTop tbody');
    tb.innerHTML = (rows||[]).map(r=>`
      <tr>
        <td>${esc(r.local_nome || '-')}</td>
        <td style="text-align:right">${fmt(Number(r.qtd || 0))}</td>
      </tr>
    `).join('');
  }

  function renderPorCidade(rows){
    const tb = qs('#tblCidade tbody');
    const totalFisc = (rows||[]).reduce((s,r)=> s + (Number(r.fiscalizacoes)||0), 0);
    tb.innerHTML = (rows||[]).map(r=>{
      const fisc = Number(r.fiscalizacoes)||0;
      const part = totalFisc ? ((fisc/totalFisc)*100).toFixed(1)+'%' : '—';
      return `
        <tr>
          <td>${esc(r.cidade||'-')}</td>
          <td style="text-align:right">${fmt(fisc)}</td>
          <td style="text-align:right">${part}</td>
          <td style="text-align:right">${fmt(Number(r.pessoas||0))}</td>
          <td style="text-align:right">${fmt(Number(r.veiculos||0))}</td>
          <td style="text-align:right">${fmt(Number(r.detidos||0))}</td>
          <td style="text-align:right">${fmt(Number(r.itens_apreendidos||0))}</td>
          <td style="text-align:right">${fmt(Number(r.apreensoes||0))}</td>
          <td style="text-align:right">${fmt(Number(r.multados||0))}</td>
          <td style="text-align:right">${fmt(Number(r.fechados||0))}</td>
          <td style="text-align:right">${fmt(Number(r.lacrados||0))}</td>
        </tr>`;
    }).join('');
    const sum = k => (rows||[]).reduce((s,r)=> s + (Number(r[k])||0), 0);
    qs('#t-fisc').textContent = fmt(totalFisc);
    qs('#t-pes').textContent  = fmt(sum('pessoas'));
    qs('#t-vei').textContent  = fmt(sum('veiculos'));
    qs('#t-det').textContent  = fmt(sum('detidos'));
    qs('#t-itm').textContent  = fmt(sum('itens_apreendidos'));
    qs('#t-apr').textContent  = fmt(sum('apreensoes'));
    qs('#t-mul').textContent  = fmt(sum('multados'));
    qs('#t-fec').textContent  = fmt(sum('fechados'));
    qs('#t-lac').textContent  = fmt(sum('lacrados'));
  }

  function renderFiscCards(rows){
    const wrap = qs('#fiscCards');
    const empty = qs('#noFisc');
    if(!rows || rows.length === 0){
      wrap.innerHTML = '';
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';
    wrap.innerHTML = rows.map(r=>{
      const flags = [
        r.multado ? '<span class="pill">Multado</span>' : '',
        r.fechado ? '<span class="pill">Fechado</span>' : '',
        r.lacrado ? '<span class="pill">Lacrado</span>' : '',
      ].join('');
      const det   = Number(r.pessoas_detidas_qtd)||0;
      const itens = Number(r.itens_apreendidos)||0;
      const itensArr  = Array.isArray(r.itens) ? r.itens : [];
      const itensHtml = itensArr.length
        ? `<ul style="margin:6px 0 0 16px;padding:0">
             ${itensArr.slice(0,5).map(it=>`
               <li>${fmt(Number(it.quantidade||0))} ${esc(it.unidade||'')} ${esc(it.tipo||'')}</li>
             `).join('')}
             ${itensArr.length>5 ? `<li>+${itensArr.length-5} itens</li>` : ''}
           </ul>`
        : '—';

      return `
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>#${r.evento_id}</strong> — ${esc(r.cidade || '-')}</div>
            <div class="muted" style="font-size:12px">${new Date(r.ts).toLocaleString('pt-BR')}</div>
          </div>
          <div style="margin-top:6px">${flags}</div>
          <div class="kv" style="margin-top:8px">
            <div class="k">Tipo do local</div><div>${esc(r.tipo_local || '-')}</div>
            <div class="k">Nome</div><div>${esc(r.local_nome || '-')}</div>
            <div class="k">Endereço</div><div>${esc(r.local_endereco || '-')}</div>
            <div class="k">Pessoas</div><div>${fmt(Number(r.pessoas_abordadas || 0))}</div>
            <div class="k">Veículos</div><div>${fmt(Number(r.veiculos_abordados || 0))}</div>
            <div class="k">Detidos</div><div>${fmt(det)}</div>
            <div class="k">Itens apreendidos</div><div>${fmt(itens)}</div>
            <div class="k">Itens (detalhe)</div><div>${itensHtml}</div>
            <div class="k">Usuário</div><div>${esc(r.usuario || '-')}</div>
          </div>
        </div>`;
    }).join('');
  }

  // ======= carregamento =======
  async function load(){
    const form = qs('#filtros');
    const opId = qs('#opId').value;

    enableExports(!!opId);
    linkCsv(); linkXlsx();

    if(!opId){
      qs('#content').classList.add('hidden');
      return;
    }

    try{
      const btn = form.querySelector('button[type="submit"]'); if(btn) btn.disabled = true;
      const params = new URLSearchParams(new FormData(form)).toString();
      const res = await fetch('/relatorios/data?' + params, { cache:'no-store' });
      if(!res.ok){ throw new Error('Erro ' + res.status + ': ' + await res.text()); }
      const data = await res.json();

      // guarda para o PDF “clean”
      __relatorioData = data;

      qs('#content').classList.remove('hidden');
      renderKPIs(data.cards||{});
      renderTopLocais(data.topLocais||[]);
      renderPorCidade(data.porCidade||[]);
      renderFiscCards(data.fiscList||[]);
    }catch(e){
      console.error('[relatorios/load]', e);
      alert('Não foi possível carregar os dados dos relatórios.\n' + (e.message || e));
    }finally{
      const btn = qs('#filtros button[type="submit"]'); if(btn) btn.disabled = false;
    }
  }

  // eventos
  qs('#filtros').addEventListener('submit', ev => { ev.preventDefault(); load(); });
  qs('#opId').addEventListener('change', () => load());
  qs('#btnPdf').addEventListener('click', (ev) => { ev.preventDefault(); generatePdf(); });

  // estado inicial
  enableExports(false);

  // ======= PDF (cliente) — layout branco profissional =======
  async function generatePdf(){
    const btn = qs('#btnPdf');
    if (!btn || btn.getAttribute('aria-disabled') === 'true') return;

    if (typeof html2pdf === 'undefined'){
      alert('PDF: biblioteca html2pdf não carregou.');
      return;
    }
    if (!__relatorioData){
      alert('Carregue os dados (Aplicar) antes de gerar o PDF.');
      return;
    }

    const form   = qs('#filtros');
    const opSel  = qs('#opId');
    const cidSel = qs('#cidadeId');
    const from   = form.querySelector('input[name="from"]').value || '-';
    const to     = form.querySelector('input[name="to"]').value   || '-';
    const opId   = opSel.value;
    const opText = opSel.value ? opSel.options[opSel.selectedIndex].textContent.trim() : '-';
    const cidadeText = cidSel.value ? cidSel.options[cidSel.selectedIndex].textContent.trim() : 'Todas';

    const {cards={}, porCidade=[], topLocais=[], fiscList=[]} = __relatorioData;

    // prepara blocos de HTML
    const kpiHtml = [
      ['Fiscalizações', cards.fiscalizacoes],
      ['Pessoas',       cards.pessoas],
      ['Veículos',      cards.veiculos],
      ['Detidos',       cards.detidos],
      ['Itens apreen.', cards.itensApreendidos],
      ['Apreensões',    cards.apreensoes],
      ['Multados',      cards.multados],
      ['Fechados',      cards.fechados],
      ['Lacrados',      cards.lacrados],
    ].map(([l,v]) => `
      <div class="kpi"><div class="lbl">${esc(l)}</div><div class="val">${fmt(v)}</div></div>
    `).join('');

    const totalF = porCidade.reduce((s,r)=>s+(Number(r.fiscalizacoes)||0),0);
    const porCidadeRows = porCidade.map(r=>{
      const f = Number(r.fiscalizacoes)||0;
      const part = totalF ? (f/totalF*100).toFixed(1)+'%' : '—';
      return `
        <tr>
          <td>${esc(r.cidade||'-')}</td>
          <td class="num">${fmt(f)}</td>
          <td class="num">${part}</td>
          <td class="num">${fmt(r.pessoas)}</td>
          <td class="num">${fmt(r.veiculos)}</td>
          <td class="num">${fmt(r.detidos)}</td>
          <td class="num">${fmt(r.itens_apreendidos)}</td>
          <td class="num">${fmt(r.apreensoes)}</td>
          <td class="num">${fmt(r.multados)}</td>
          <td class="num">${fmt(r.fechados)}</td>
          <td class="num">${fmt(r.lacrados)}</td>
        </tr>`;
    }).join('');

    const topLocaisRows = topLocais.map(r =>
      `<tr><td>${esc(r.local_nome||'-')}</td><td class="num">${fmt(r.qtd)}</td></tr>`
    ).join('');

    const fiscRows = fiscList.map(r=>{
      const itensArr = Array.isArray(r.itens) ? r.itens : [];
      const itensStr = itensArr.length
        ? itensArr.map(it => `${fmt(it.quantidade)} ${esc(it.unidade||'')} ${esc(it.tipo||'')}`).join('; ')
        : '—';
      const check = (b)=> b ? '✓' : '';
      return `
        <tr>
          <td>#${fmt(r.evento_id)}</td>
          <td>${esc(new Date(r.ts).toLocaleString('pt-BR'))}</td>
          <td>${esc(r.cidade||'-')}</td>
          <td>${esc(r.tipo_local||'-')}</td>
          <td>${esc(r.local_nome||'-')}</td>
          <td>${esc(r.local_endereco||'-')}</td>
          <td class="num">${fmt(r.pessoas_abordadas)}</td>
          <td class="num">${fmt(r.veiculos_abordados)}</td>
          <td class="num">${fmt(r.pessoas_detidas_qtd)}</td>
          <td class="num">${fmt(r.itens_apreendidos)}</td>
          <td class="num">${check(r.multado)}</td>
          <td class="num">${check(r.fechado)}</td>
          <td class="num">${check(r.lacrado)}</td>
        </tr>
        <tr><td colspan="13" class="small"><span class="muted">Itens (detalhe):</span> ${itensStr}</td></tr>
      `;
    }).join('');

    const html = `
      <div id="pdf-wrap">
        <style>
          *{box-sizing:border-box}
          body{margin:0}
          .wrap{padding:20px 22px; color:#111; font:12px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:#fff}
          .hdr{display:flex; align-items:center; gap:14px; border-bottom:2px solid #e5e7eb; padding-bottom:10px; margin-bottom:10px}
          .hdr img{height:56px; object-fit:contain}
          .title{font-size:20px; font-weight:800; margin:0}
          .subtitle{color:#555; margin-top:2px}
          .meta{display:grid; grid-template-columns:auto 1fr; gap:4px 10px; border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin:12px 0}
          .meta .k{color:#666}
          .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin:12px 0}
          .kpi{border:1px solid #e5e7eb; border-radius:10px; padding:10px}
          .kpi .lbl{font-size:11px; color:#666}
          .kpi .val{font-size:18px; font-weight:800; margin-top:2px}
          h3{font-size:14px; margin:16px 0 6px; border-left:3px solid #111; padding-left:8px}
          table{width:100%; border-collapse:collapse; table-layout:fixed}
          th,td{border:1px solid #e5e7eb; padding:6px 8px; vertical-align:top}
          th{background:#f7f7f7; text-align:left; font-weight:700}
          td.num, th.num{text-align:right}
          .muted{color:#666}
          .two-col{display:grid; grid-template-columns:1.2fr .8fr; gap:12px}
          .page-break{page-break-before:always; margin-top:12px}
          .nowrap{white-space:nowrap}
          .w-120{width:120px}.w-160{width:160px}.w-220{width:220px}
          .small{font-size:11px}
        </style>

        <div class="wrap">
          <div class="hdr">
            <img src="${esc(LOGO_URL)}" alt="Logo"/>
            <div>
              <h1 class="title">Relatório — Operação</h1>
              <div class="subtitle">Centro de Inteligência Metropolitana</div>
            </div>
            <div style="margin-left:auto; text-align:right" class="small muted">
              Emitido em ${esc(new Date().toLocaleString('pt-BR'))}
            </div>
          </div>

          <div class="meta">
            <div class="k">Operação</div><div>${esc(opText)}</div>
            <div class="k">Período</div><div>${esc(from)} — ${esc(to)}</div>
            <div class="k">Cidade</div><div>${esc(cidadeText)}</div>
          </div>

          <div class="kpis">${kpiHtml}</div>

          <div class="two-col">
            <div>
              <h3>Distribuição por cidade</h3>
              <table>
                <thead>
                  <tr>
                    <th>Cidade</th>
                    <th class="num">Fiscalizações</th>
                    <th class="num">% part.</th>
                    <th class="num">Pessoas</th>
                    <th class="num">Veículos</th>
                    <th class="num">Detidos</th>
                    <th class="num">Itens</th>
                    <th class="num">Apreensões</th>
                    <th class="num">Multados</th>
                    <th class="num">Fechados</th>
                    <th class="num">Lacrados</th>
                  </tr>
                </thead>
                <tbody>${porCidadeRows}</tbody>
              </table>
            </div>

            <div>
              <h3>Top locais fiscalizados</h3>
              <table>
                <thead><tr><th>Local</th><th class="num">Qtd.</th></tr></thead>
                <tbody>${topLocaisRows}</tbody>
              </table>
            </div>
          </div>

          <div class="page-break"></div>

          <h3>Fiscalizações (detalhe)</h3>
          <table>
            <thead>
              <tr>
                <th class="w-120">Evento</th>
                <th class="w-160">Data/Hora</th>
                <th>Cidade</th>
                <th>Tipo do local</th>
                <th>Nome do local</th>
                <th class="w-220">Endereço</th>
                <th class="num">Pessoas</th>
                <th class="num">Veículos</th>
                <th class="num">Detidos</th>
                <th class="num">Itens</th>
                <th class="nowrap">Mult.</th>
                <th class="nowrap">Fech.</th>
                <th class="nowrap">Lacr.</th>
              </tr>
            </thead>
            <tbody>${fiscRows}</tbody>
          </table>
        </div>
      </div>`;

    // injeta e exporta
    const container = document.createElement('div');
    container.innerHTML = html;
    document.body.appendChild(container);

    await html2pdf().set({
      margin:[10,10,10,10],
      filename:`relatorio_operacao_${opId || 'filtro'}.pdf`,
      image:{ type:'jpeg', quality:0.98 },
      html2canvas:{ scale:2, useCORS:true },
      jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }
    }).from(container.querySelector('#pdf-wrap')).save();

    container.remove();
  }
</script>


</body>

</html>