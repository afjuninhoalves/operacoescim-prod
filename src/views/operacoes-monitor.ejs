<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitor — <%= operacao.nome %>
  </title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --panel2: #111827;
      --border: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --chip: #1f2937;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial
    }

    a {
      color: inherit;
      text-decoration: none
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(to bottom, rgba(17, 24, 39, .92), rgba(17, 24, 39, .75));
      border-bottom: 1px solid var(--border)
    }

    .topbar-inner {
      max-width: 1160px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #111826
    }

    .btn:hover {
      filter: brightness(1.08)
    }

    .container {
      max-width: 1160px;
      margin: 0 auto;
      padding: 20px
    }

    .muted {
      color: var(--muted)
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 12px
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px
    }

    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px
    }

    .kpi-title {
      font-size: 13px;
      color: var(--muted)
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700
    }

    .kpi-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px
    }

    .grid {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      margin-top: 14px
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      text-align: center
    }

    th:first-child,
    td:first-child {
      text-align: left
    }

    .chip {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--chip);
      font-size: 12px
    }

    @media (max-width:1100px) {
      .cards {
        grid-template-columns: repeat(2, 1fr)
      }

      .grid {
        grid-template-columns: 1fr
      }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div>
        <div style="font-weight:700">Monitor — <%= operacao.nome %>
        </div>
        <div class="muted">Agendada: <%= operacao.inicio_fmt %> · ID #<%= operacao.id %>
        </div>
      </div>
      <div style="display:flex;gap:10px">
        <a class="btn" href="/operacoes/<%= operacao.id %>">Voltar ao detalhe</a>
        <a class="btn" href="/operacoes/<%= operacao.id %>/mapa">Mapa das fiscalizações</a>
        <a class="btn" href="/operacoes">Lista de operações</a>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- KPIs -->
    <div class="cards">
      <div class="card">
        <div class="kpi-title">Locais fiscalizados</div>
        <div class="kpi-value">
          <%= (cards && cards.locais) || 0 %>
        </div>
      </div>
      <div class="card">
        <div class="kpi-title">Pessoas</div>
        <div class="kpi-value">
          <%= (cards && cards.pessoas) || 0 %>
        </div>
      </div>
      <div class="card">
        <div class="kpi-title">Veículos</div>
        <div class="kpi-value">
          <%= (cards && cards.veiculos) || 0 %>
        </div>
      </div>
      <div class="card">
        <div class="kpi-title">Apreensões</div>
        <div class="kpi-value">
          <%= (cards && cards.apreensoes) || 0 %>
        </div>
      </div>
      <div class="card">
        <div class="kpi-title">Multados</div>
        <div class="kpi-value">
          <%= (cards && cards.multados) || 0 %>
        </div>
      </div>
      <div class="card">
        <div class="kpi-title">Fechados</div>
        <div class="kpi-value">
          <%= (cards && cards.fechados) || 0 %>
        </div>
      </div>
      <div class="card">
        <div class="kpi-title">Lacrados</div>
        <div class="kpi-value">
          <%= (cards && cards.lacrados) || 0 %>
        </div>
      </div>


      <!-- Efetivo total -->
      <div class="card">
        <div class="kpi-title">Efetivo total de GCM´s</div>
        <div class="kpi-value">
          <%= (efetivo && Number(efetivo.total_agentes)) || 0 %> ag.
        </div>
        <div class="kpi-sub">
          <%= (efetivo && Number(efetivo.total_viaturas)) || 0 %> viaturas
        </div>
      </div>

      <!-- PC -->
      <div class="card">
        <div class="kpi-title">Polícia Civil</div>
        <div class="kpi-value">
          <%= (efetivo && Number(efetivo.pc_agentes)) || 0 %> ag.
        </div>
        <div class="kpi-sub">
          <%= (efetivo && Number(efetivo.pc_viaturas)) || 0 %> viaturas
        </div>
      </div>

      <!-- PM -->
      <div class="card">
        <div class="kpi-title">Polícia Militar</div>
        <div class="kpi-value">
          <%= (efetivo && Number(efetivo.pm_agentes)) || 0 %> ag.
        </div>
        <div class="kpi-sub">
          <%= (efetivo && Number(efetivo.pm_viaturas)) || 0 %> viaturas
        </div>
      </div>

      <!-- Outros -->
      <div class="card">
        <div class="kpi-title">Outros órgãos</div>
        <div class="kpi-value">
          <%= (efetivo && Number(efetivo.outros_agentes)) || 0 %> ag.
        </div>
        <div class="kpi-sub">
          <%= (efetivo && Number(efetivo.outros_viaturas)) || 0 %> viaturas
        </div>
      </div>
    </div>

    <!-- Card do gráfico -->
    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">Distribuição por cidade</h3>
        <div class="muted" style="font-size:13px">
          <span
            style="display:inline-block;width:10px;height:10px;background:#60a5fa;border-radius:50%;margin-right:6px"></span>Fiscalizações
          &nbsp;&nbsp;<span
            style="display:inline-block;width:10px;height:10px;background:#f87171;border-radius:50%;margin-right:6px"></span>Pessoas
          &nbsp;&nbsp;<span
            style="display:inline-block;width:10px;height:10px;background:#34d399;border-radius:50%;margin-right:6px"></span>Veículos
          &nbsp;&nbsp;<span
            style="display:inline-block;width:10px;height:10px;background:#fbbf24;border-radius:50%;margin-right:6px"></span>Apreensões
        </div>
      </div>

      <div id="chartWrap" style="position:relative;height:340px">
        <canvas id="byCityChart"></canvas>
      </div>

      <div id="noChartData" class="muted" style="display:none;margin-top:8px">
        Sem dados suficientes para o gráfico.
      </div>
    </div>

    <!-- Chart.js (apenas UMA vez) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script>
      // dados vindos do servidor (corrigido: <%- ... %>)
      const series = <% - JSON.stringify(seriesPorCidade || []) %>;

      function hasAnyValue(rows) {
        return Array.isArray(rows) && rows.some(r =>
          (Number(r.fiscalizacao) || 0) +
          (Number(r.pessoa) || 0) +
          (Number(r.veiculo) || 0) +
          (Number(r.apreensao) || 0) > 0
        );
      }

      window.addEventListener('load', () => {
        const canvas = document.getElementById('byCityChart');
        const noData = document.getElementById('noChartData');

        if (!hasAnyValue(series)) {
          noData.style.display = 'block';
          return;
        }

        // garante dimensões do canvas dentro do container
        canvas.style.width = '100%';
        canvas.style.height = '100%';

        const labels = series.map(r => r.cidade);
        const mk = (k, label, color) => ({
          label,
          data: series.map(r => Number(r[k] || 0)),
          backgroundColor: color,
          borderColor: color,
          borderWidth: 1,
          borderRadius: 6,
          maxBarThickness: 36
        });

        const data = {
          labels,
          datasets: [
            mk('fiscalizacao', 'Fiscalizações', '#60a5fa'),
            mk('pessoa', 'Pessoas', '#f87171'),
            mk('veiculo', 'Veículos', '#34d399'),
            mk('apreensao', 'Apreensões', '#fbbf24'),
          ]
        };

        new Chart(canvas.getContext('2d'), {
          type: 'bar',
          data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            scales: {
              x: { ticks: { color: '#e5e7eb' }, grid: { display: false } },
              y: { beginAtZero: true, ticks: { precision: 0, color: '#e5e7eb' }, grid: { color: 'rgba(229,231,235,0.1)' } }
            },
            plugins: { legend: { position: 'top', labels: { color: '#e5e7eb' } } }
          }
        });
      });
    </script>



    <div class="grid">
      <!-- Tabela por cidade -->
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Distribuição por cidade</div>
        <table>
          <thead>
            <tr>
              <th>Cidade</th>
              <th>Fiscalizações</th>
              <th>Pessoas</th>
              <th>Veículos</th>
              <th>Apreensões</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <% (seriesPorCidade||[]).forEach(row=> {
              const fisc = Number(row.fiscalizacao || 0);
              const pes = Number(row.pessoa || 0);
              const vei = Number(row.veiculo || 0);
              const apr = Number(row.apreensao || 0);
              const total = fisc + pes + vei + apr;
              %>
              <tr>
                <td>
                  <%= row.cidade %>
                </td>
                <td>
                  <%= fisc %>
                </td>
                <td>
                  <%= pes %>
                </td>
                <td>
                  <%= vei %>
                </td>
                <td>
                  <%= apr %>
                </td>
                <td>
                  <%= total %>
                </td>
              </tr>
              <% }) %>
          </tbody>
        </table>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Efetivo por cidade</div>
        <% const efRows=Array.isArray(efetivoByCity) ? efetivoByCity : []; const t=efRows.reduce((a, r)=> ({
          ag: a.ag + (Number(r.agentes)||0),
          vt: a.vt + (Number(r.viaturas)||0),
          pc_ag: a.pc_ag + (Number(r.pc_agentes)||0),
          pc_vt: a.pc_vt + (Number(r.pc_viaturas)||0),
          pm_ag: a.pm_ag + (Number(r.pm_agentes)||0),
          pm_vt: a.pm_vt + (Number(r.pm_viaturas)||0),
          ou_ag: a.ou_ag + (Number(r.outros_agentes)||0),
          ou_vt: a.ou_vt + (Number(r.outros_viaturas)||0),
          }), {ag:0,vt:0,pc_ag:0,pc_vt:0,pm_ag:0,pm_vt:0,ou_ag:0,ou_vt:0});
          %>
          <table>
            <thead>
              <tr>
                <th>Cidade</th>
                <th>Agentes</th>
                <th>Viaturas</th>
                <th>PC (ag.)</th>
                <th>PC (viat.)</th>
                <th>PM (ag.)</th>
                <th>PM (viat.)</th>
                <th>Outros (ag.)</th>
                <th>Outros (viat.)</th>
              </tr>
            </thead>
            <tbody>
              <% efRows.forEach(r=> { %>
                <tr>
                  <td>
                    <%= r.cidade %>
                  </td>
                  <td>
                    <%= r.agentes || 0 %>
                  </td>
                  <td>
                    <%= r.viaturas || 0 %>
                  </td>
                  <td>
                    <%= r.pc_agentes || 0 %>
                  </td>
                  <td>
                    <%= r.pc_viaturas || 0 %>
                  </td>
                  <td>
                    <%= r.pm_agentes || 0 %>
                  </td>
                  <td>
                    <%= r.pm_viaturas || 0 %>
                  </td>
                  <td>
                    <%= r.outros_agentes || 0 %>
                  </td>
                  <td>
                    <%= r.outros_viaturas || 0 %>
                  </td>
                </tr>
                <% }) %>
                  <tr>
                    <th>Total</th>
                    <th>
                      <%= t.ag %>
                    </th>
                    <th>
                      <%= t.vt %>
                    </th>
                    <th>
                      <%= t.pc_ag %>
                    </th>
                    <th>
                      <%= t.pc_vt %>
                    </th>
                    <th>
                      <%= t.pm_ag %>
                    </th>
                    <th>
                      <%= t.pm_vt %>
                    </th>
                    <th>
                      <%= t.ou_ag %>
                    </th>
                    <th>
                      <%= t.ou_vt %>
                    </th>
                  </tr>
            </tbody>
          </table>
      </div>




      <!-- Feed -->
      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Feed (últimos 20)</div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <% (feed||[]).forEach(f=> { %>
            <div style="padding:10px;border:1px solid var(--border);border-radius:10px">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                <span class="chip">
                  <%= f.tipo %>
                </span>
                <span class="muted" style="font-size:12px">
                  <%= new Date(f.ts).toLocaleString('pt-BR') %>
                </span>
              </div>
              <div class="muted" style="margin-top:6px">
                <%= f.cidade %>
                  <% if (f.cidade && f.user) { %> · <% } %>
                      <%= f.user %>
              </div>
              <% if (f.obs) { %>
                <div style="margin-top:6px">
                  <%= f.obs %>
                </div>
                <% } %>
            </div>
            <% }) %>
        </div>
      </div>
    </div>
  </div>
</body>

</html>